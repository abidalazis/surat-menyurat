<style>
    .data-surat-container { padding: 0; }
    .page-header { margin-bottom: 25px; }
    .page-title { font-size: 24px; font-weight: 600; margin-bottom: 5px; color: #2c3e50; }
    .page-subtitle { color: #7f8c8d; font-size: 14px; }
    .filter-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 13px; color: #555; font-weight: 500; }
    .filter-group input, .filter-group select { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; outline: none; }
    .filter-group input:focus, .filter-group select:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .filter-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-data { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
    .btn-data.btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
    .btn-data.btn-secondary:hover { background: rgba(102, 126, 234, 0.1); }
    .btn-data.btn-success { background: #28a745; color: white; }
    .btn-data.btn-warning { background: #ffc107; color: #333; }
    .btn-data.btn-info { background: #17a2b8; color: white; }
    .btn-data.btn-success:hover { background: #218838; }
    .btn-data.btn-warning:hover { background: #e0a800; }
    .btn-data.btn-info:hover { background: #138496; }
    .table-section { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .table-title { font-size: 16px; font-weight: 600; color: #2c3e50; }
    .result-count { font-size: 14px; color: #7f8c8d; }
    .data-table-container { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    .data-table thead { background: #f8f9fa; }
    .data-table thead th { padding: 15px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; }
    .data-table tbody tr { border-bottom: 1px solid #f0f0f0; transition: all 0.2s ease; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .data-table tbody td { padding: 15px 12px; font-size: 14px; color: #333; }
    .badge-biasa { background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-penting { background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-segera { background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-sangat-segera { background: #f3e5f5; color: #6a1b9a; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-rahasia { background: #e0e0e0; color: #424242; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .action-buttons { display: flex; gap: 5px; }
    .btn-action { padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
    .btn-view { background: #17a2b8; color: white; }
    .btn-print { background: #28a745; color: white; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-action:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .empty-state-data { padding: 60px 20px; text-align: center; color: #95a5a6; }
    .empty-icon { font-size: 64px; margin-bottom: 15px; }
    .alert-data { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .alert-data.show { display: block; }
    .alert-data.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-data.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
  
  <div class="data-surat-container" id="data-surat-masuk-root">
    <div class="page-header">
      <h1 class="page-title">üì® Data Surat Masuk</h1>
      <p class="page-subtitle">Kelola dan lihat semua surat masuk</p>
    </div>
    
    <div id="alertDataMasuk" class="alert-data"></div>
    
    <div class="filter-section">
      <div class="filter-grid">
        <div class="filter-group">
          <label>üîç Cari Surat</label>
          <input type="text" id="searchInputMasuk" placeholder="No agenda, surat dari, perihal..." onkeyup="filterTableMasuk()">
        </div>
        <div class="filter-group">
          <label>üìÅ Bidang</label>
          <select id="filterBidangMasuk" onchange="filterTableMasuk()">
            <option value="">Semua Bidang</option>
            <option value="Sekretariat">Sekretariat</option>
            <option value="Tata Pemerintahan">Tata Pemerintahan</option>
            <option value="Pemberdayaan Masyarakat">Pemberdayaan Masyarakat</option>
            <option value="Pelayanan Umum">Pelayanan Umum</option>
            <option value="Kesejahteraan Masyarakat">Kesejahteraan Masyarakat</option>
            <option value="Trantib">Trantib</option>
          </select>
        </div>
        <div class="filter-group">
          <label>‚ö° Sifat</label>
          <select id="filterSifatMasuk" onchange="filterTableMasuk()">
            <option value="">Semua Sifat</option>
            <option value="Biasa">Biasa</option>
            <option value="Penting">Penting</option>
            <option value="Segera">Segera</option>
            <option value="Sangat Segera">Sangat Segera</option>
            <option value="Rahasia">Rahasia</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn-data btn-secondary" onclick="resetFilterMasuk()">üîÑ Reset</button>
        <button class="btn-data btn-success" onclick="exportToExcelMasuk()">üìä Excel</button>
        <button class="btn-data btn-warning" onclick="window.print()">üñ®Ô∏è Print</button>
      </div>
    </div>
    
    <div class="table-section">
      <div class="table-header">
        <div class="table-title">üìã Daftar Surat Masuk</div>
        <div class="result-count" id="resultCountMasuk">Loading...</div>
      </div>
      <div class="data-table-container" id="tableContentMasuk">
        <div class="empty-state-data">
          <div class="empty-icon">‚è≥</div>
          <h3>Memuat Data...</h3>
          <p>Mohon tunggu sebentar</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
  (function() {
    /**
     * DataSuratMasuk.html - Robust Script
     */
    let dataLoadedMasuk = false;
    let sessionIdMasuk = '';
    let userRoleMasuk = '';
    let userBidangMasuk = '';
    
    // Get data attributes from container
    const root = document.getElementById('tab-data-masuk');
    if (root) {
      sessionIdMasuk = root.getAttribute('data-session-id') || '';
      userRoleMasuk = root.getAttribute('data-user-role') || '';
      userBidangMasuk = root.getAttribute('data-user-bidang') || '';
      console.log('‚úì Session and Role attributes loaded');
    }
    
    if (!sessionIdMasuk && window.SESSION_ID) {
      sessionIdMasuk = window.SESSION_ID;
    }
    
    console.log('=== DataSuratMasuk Initialization ===');
    
    function loadDataSuratMasuk() {
      console.log('üöÄ loadDataSuratMasuk triggered');
      
      if (!sessionIdMasuk || sessionIdMasuk === 'undefined') {
        showErrorMasuk('Session tidak valid. Silakan login kembali.');
        return;
      }
      
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        showErrorMasuk('Error: google.script.run tidak tersedia');
        return;
      }

      console.log('üöÄ Loading data for Data Masuk...');
      console.log('Session ID (Masuk):', sessionIdMasuk ? (sessionIdMasuk.substring(0,20) + '...') : 'NULL/EMPTY');

      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        showErrorMasuk('Error: google.script.run tidak tersedia');
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          console.log('‚úÖ Response received for Data Masuk:', response);
          
          if (!response) {
            console.error('‚ùå ERROR: Server returned null/undefined for Data Masuk');
            showErrorMasuk('Data tidak ditemukan (Server return null)');
            return;
          }
          
          // Format standar: { success: true, data: [] }
          let dataToRender = [];
          if (response.success && Array.isArray(response.data)) {
            dataToRender = response.data;
          } else if (Array.isArray(response)) {
            dataToRender = response;
          } else {
            console.error('‚ùå ERROR: Invalid response format', response);
            showErrorMasuk(response.message || 'Gagal memuat data dari server');
            return;
          }
          
          console.log('‚úì Success rendering ' + dataToRender.length + ' records');
          renderTableMasuk(dataToRender);
          dataLoadedMasuk = true;
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Server error in loadDataSuratMasuk:', error);
          showErrorMasuk('Error Server: ' + error.message);
        })
        .fetchSuratMasukData(sessionIdMasuk, userRoleMasuk, userBidangMasuk);
    }
    
    function renderTableMasuk(data) {
      const container = document.getElementById('tableContentMasuk');
      const resultCount = document.getElementById('resultCountMasuk');
      
      if (!container || !resultCount) return;
      
      // Defensively check data again
      if (!data) {
         resultCount.textContent = '0 surat masuk ditemukan';
         container.innerHTML = '<div class="empty-state-data"><h3>Data Kosong</h3></div>';
         return;
      }
      
      const count = data.length || 0;
      resultCount.textContent = count + ' surat masuk ditemukan';
      
      if (count === 0) {
        container.innerHTML = '<div class="empty-state-data"><div class="empty-icon">üì≠</div><h3>Tidak Ada Data</h3><p>Belum ada surat masuk yang tercatat.</p></div>';
        return;
      }
      
      let html = '<table class="data-table" id="suratTableMasuk"><thead><tr><th>No</th><th>No Agenda</th><th>Diterima</th><th>Surat Dari</th><th>No Surat</th><th>Tgl Surat</th><th>Perihal</th><th>Sifat</th><th>Bidang</th><th>Aksi</th></tr></thead><tbody>';
      
      window.suratMasukCache = {};
      
      data.forEach(function(item, i) {
        if (!item) return;
        window.suratMasukCache[item.id] = item;
        const sifatClass = 'badge-' + (item.sifat || 'biasa').toLowerCase().replace(/ /g, '-');
        
        // Use safer concatenation
        html += '<tr data-agenda="' + (item.nomorAgenda || '') + '" data-bidang="' + (item.bidang || '') + '" data-sifat="' + (item.sifat||'') + '" data-dari="' + (item.suratDari||'') + '" data-perihal="' + (item.perihal||'') + '">' +
          '<td>' + (i+1) + '</td>' +
          '<td><strong>' + (item.nomorAgenda || '-') + '</strong></td>' +
          '<td>' + (item.diterimaTanggal || '-') + '</td>' +
          '<td>' + (item.suratDari || '-') + '</td>' +
          '<td>' + (item.noSurat || '-') + '</td>' +
          '<td>' + (item.tanggalFormat || item.tanggalSurat || '-') + '</td>' +
          '<td>' + (item.perihal || '-') + '</td>' +
          '<td><span class="' + sifatClass + '">' + (item.sifat || 'Biasa') + '</span></td>' +
          '<td>' + (item.bidang || '-') + '</td>' +
          '<td><div class="action-buttons">' +
          '<button class="btn-action btn-print" type="button" onclick="printDisposisi(\'' + item.id + '\')" title="Print Disposisi">üñ®Ô∏è</button>' +
          '<button class="btn-action btn-delete" type="button" onclick="confirmDelete(\'' + item.id + '\',\'' + (item.nomorAgenda || '') + '\')" title="Hapus">üóëÔ∏è</button>' +
          '</div></td></tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    window.filterTableMasuk = function() {
      const search = document.getElementById('searchInputMasuk').value.toLowerCase();
      const bidang = document.getElementById('filterBidangMasuk').value;
      const sifat = document.getElementById('filterSifatMasuk').value;
      const table = document.getElementById('suratTableMasuk');
      if (!table) return;
      
      const tbody = table.getElementsByTagName('tbody')[0];
      if (!tbody) return;
      
      const rows = tbody.getElementsByTagName('tr');
      let count = 0;
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row) continue;
        
        const agenda = (row.getAttribute('data-agenda') || '').toLowerCase();
        const rowBidang = row.getAttribute('data-bidang') || '';
        const rowSifat = row.getAttribute('data-sifat') || '';
        const dari = (row.getAttribute('data-dari') || '').toLowerCase();
        const perihal = (row.getAttribute('data-perihal') || '').toLowerCase();
        
        const matchSearch = !search || agenda.includes(search) || dari.includes(search) || perihal.includes(search);
        const matchBidang = !bidang || rowBidang === bidang;
        const matchSifat = !sifat || rowSifat === sifat;
        
        if (matchSearch && matchBidang && matchSifat) {
          row.style.display = '';
          count++;
        } else {
          row.style.display = 'none';
        }
      }
      document.getElementById('resultCountMasuk').textContent = count + ' surat masuk ditemukan';
    };
    
    window.resetFilterMasuk = function() {
      const s = document.getElementById('searchInputMasuk');
      const b = document.getElementById('filterBidangMasuk');
      const sf = document.getElementById('filterSifatMasuk');
      if (s) s.value = '';
      if (b) b.value = '';
      if (sf) sf.value = '';
      window.filterTableMasuk();
    };
    
    window.printDisposisi = function(id) {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(html) {
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Gagal: ' + error.message);
          })
          .generateDisposisiHTML(id);
      }
    };
    
    window.confirmDelete = function(id, agenda) {
      if (confirm('Hapus surat masuk dengan No Agenda: ' + agenda + '?')) {
        alert('Fitur hapus segera hadir');
      }
    };
    
    function showErrorMasuk(msg) {
      const container = document.getElementById('tableContentMasuk');
      const countEl = document.getElementById('resultCountMasuk');
      if (container) {
        container.innerHTML = '<div class="empty-state-data"><div class="empty-icon">‚ö†Ô∏è</div><h3>Error</h3><p>' + msg + '</p></div>';
      }
      if (countEl) countEl.textContent = 'Error';
    }
    
    window.exportToExcelMasuk = function() {
      alert('Fitur Excel segera hadir');
    };

    // Expose for dashboard
    window.loadDataSuratMasuk = loadDataSuratMasuk;

    // Load if active
    if (root) {
      setTimeout(loadDataSuratMasuk, 1000);
    }
  })();
  </script>
